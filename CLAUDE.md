# CLAUDE.md — Developer Guide for graphtty

## Architecture

- **Package**: `src/graphtty/` with `canvas.py`, `renderer.py`, `themes.py`, `types.py`, `__main__.py`
- **Import**: `from graphtty import render, AsciiGraph, AsciiNode, AsciiEdge`
- **CLI**: `uv run graphtty <file.json> [--theme NAME] [--ascii] [--no-types]`
- **Layout engine**: grandalf (Sugiyama algorithm) for hierarchical DAG layout
- **Data models**: `AsciiGraph`, `AsciiNode`, `AsciiEdge` in `types.py` (Pydantic, `ConfigDict(extra="ignore")`)
- **Dependencies**: `grandalf>=0.8`, `pydantic>=2.0` (standalone, no external runtime dependency)

## Key Design Decisions

- Canvas uses a parallel `_colors` grid (not inline ANSI) for clean color support
- Themes are frozen dataclasses with per-node-type styles; "default" theme = no colors
- `to_string(use_color=True)` emits ANSI codes with run-length optimization
- `_metadata_lines()` wraps `node.description` into display lines (max 40 chars)
- Type label shown ONLY in top border (not as content line) to avoid redundancy
- **Types are generic/agnostic** — legacy metadata mapping (`model_name`, `tool_names`) lives ONLY in `__main__.py` (`_preprocess_nodes`), not in the library types
- Node `description` field is the generic way to add detail lines under the node name

## Rules

- After modifying any Python file, always run `uv run ruff format .` before finishing
- After modifying any Python file, always run `uv run ruff check --fix .` before finishing
- Commit messages MUST follow the [Conventional Commits](https://www.conventionalcommits.org/) format: `type(scope): description` (e.g. `feat: add adaptive width rendering`, `fix(renderer): handle zero-width canvas`). Valid types: `feat`, `fix`, `docs`, `style`, `refactor`, `perf`, `test`, `build`, `ci`, `chore`, `revert`. The repo uses commitlint to enforce this.

## Common Commands

```bash
uv sync                                  # install dependencies
uv run pytest tests/ -v                  # run tests
uv run graphtty samples/react-agent/graph.json              # render a sample
uv run graphtty samples/react-agent/graph.json --theme monokai  # with theme
uv run python scripts/generate_screenshots.py                # regenerate PNGs
```

## Edge Routing

- **Backward edges**: `_backward_edge_corridors()` computes global route_x (right of ALL boxes) so corridors never cut through other nodes
- **Near-straight edges**: `_STRAIGHT_TOLERANCE = 2` prevents Z-shapes when src/tgt centers differ by <=2 chars
- **Z-shape routing**: `mid_y = start_y + 2` keeps horizontal segment near source to avoid cutting through tall subgraph boxes

## Subgraph Rendering

- **CRITICAL**: Subgraphs rendered as Canvas objects via `_render_canvas()`, then blitted canvas-to-canvas with `blit_canvas()`
- Never render subgraphs as strings with ANSI codes — `len()` counts escape chars, which breaks box sizing

## Screenshots

- PNG screenshots in `screenshots/`, generated by `scripts/generate_screenshots.py` (uses Pillow + Cascadia Mono font)
- 4 samples: react-agent (monokai), deep-agent (ocean), workflow-agent (forest), supervisor-agent (dracula)
- GitHub strips SVG foreignObject/style elements, so use PNG not SVG for README

## Gotchas

- Windows cp1252 encoding: CLI uses `sys.stdout.reconfigure(encoding='utf-8')`
- `PYTHONIOENCODING=utf-8` needed when running from shell on Windows
- grandalf returns center coordinates; convert to top-left Box with `cx - w/2`
- Use combined ANSI sequences (`\033[2;32m`) not compound (`\033[2m\033[32m`)
- `to_string()` strips both leading AND trailing empty lines to avoid asymmetric padding
